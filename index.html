<script>
const sampleData = [
  // Removed demo data – live data will be loaded
];

let currentTargetInput = null;

document.querySelectorAll('.price-field button').forEach(btn => {
  btn.addEventListener('click', () => {
    currentTargetInput = btn.previousElementSibling;
    document.getElementById('fuel-popup').style.display = 'block';
    document.getElementById('fuel-search-results').innerHTML = 'Loading...';

    const fuelType = document.getElementById('fuel-type').value;

    fetch('/api/fuel')
      .then(res => res.json())
      .then(data => {
        const stations = data.stations || [];
        const results = stations.filter(station => {
          const price = fuelType === 'petrol' ? station.unleaded : station.diesel;
          return price !== null;
        });

        if (results.length === 0) {
          document.getElementById('fuel-search-results').innerHTML = '<p>No live data available.</p>';
          return;
        }

        const html = results.map(station => {
          const price = fuelType === 'petrol' ? station.unleaded : station.diesel;
          return `
            <div class="fuel-option" data-price="${price}">
              <strong>${station.brand}</strong> – ${station.postcode}<br>
              ${fuelType.toUpperCase()}: <strong>${price}p</strong>
            </div>
          `;
        }).join('');

        document.getElementById('fuel-search-results').innerHTML = html;

        document.querySelectorAll('.fuel-option').forEach(opt => {
          opt.addEventListener('click', () => {
            if (currentTargetInput) {
              currentTargetInput.value = (parseFloat(opt.dataset.price) / 100).toFixed(2); // Convert to £
              currentTargetInput.dispatchEvent(new Event('input'));
            }
            document.getElementById('fuel-popup').style.display = 'none';
          });
        });
      })
      .catch(err => {
        console.error(err);
        document.getElementById('fuel-search-results').innerHTML = '<p>Error loading fuel data.</p>';
      });
  });
});

document.getElementById('close-fuel-popup').addEventListener('click', () => {
  document.getElementById('fuel-popup').style.display = 'none';
});
</script>
