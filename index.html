<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Is it Worth It?</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    body { font-family: sans-serif; padding: 2rem; max-width: 800px; margin: auto; }
    input, select, button { padding: 0.5rem; margin: 0.5rem 0; width: 100%; }
    .price-row { display: flex; gap: 0.5rem; align-items: center; }
    .price-row input { flex: 1; }
    .price-row button { flex: 0 0 auto; }
    #output { margin-top: 2rem; border-top: 1px solid #ccc; padding-top: 1rem; }
    .popup {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 10;
    }
    .popup-content {
      background: white;
      padding: 1rem;
      max-width: 500px;
      margin: 5% auto;
      border-radius: 5px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .station-item {
      border-bottom: 1px solid #ddd;
      padding: 0.5rem 0;
      cursor: pointer;
    }
    .station-item:hover {
      background: #f0f0f0;
    }
  </style>
</head>
<body>

  <h1>Is it Worth It?</h1>

  <label for="fuel-type">Fuel Type:</label>
  <select id="fuel-type">
    <option value="unleaded">Petrol (Unleaded)</option>
    <option value="diesel">Diesel</option>
  </select>

  <label for="local-price">Local Price (p/L):</label>
  <div class="price-row">
    <input type="number" id="local-price" placeholder="e.g. 145.9" />
    <button onclick="openFuelPopup('local')">Find Price</button>
  </div>

  <label for="cheaper-price">Cheaper Price (p/L):</label>
  <div class="price-row">
    <input type="number" id="cheaper-price" placeholder="e.g. 139.9" />
    <button onclick="openFuelPopup('cheaper')">Find Price</button>
  </div>

  <label for="trip-distance">Round Trip Distance (miles):</label>
  <input type="number" id="trip-distance" placeholder="e.g. 10" />

  <label for="mpg">Your Vehicle's MPG:</label>
  <input type="number" id="mpg" placeholder="e.g. 40" />

  <button onclick="calculate()">Calculate</button>

  <div id="output"></div>

  <!-- Fuel Finder Popup -->
  <div class="popup" id="fuel-popup">
    <div class="popup-content">
      <h2>Select Fuel Price</h2>
      <input type="text" id="fuel-search" placeholder="Enter town or postcode" oninput="filterStations()" />
      <div id="stationList"></div>
      <button onclick="closeFuelPopup()">Close</button>
    </div>
  </div>

  <script>
    let stations = [];
    let currentFuelField = null;

    async function openFuelPopup(field) {
      currentFuelField = field;
      document.getElementById('stationList').innerHTML = "Loading...";
      document.getElementById('fuel-popup').style.display = 'block';

      try {
        const res = await fetch('/api/fuel');
        const data = await res.json();
        stations = data.stations || [];
        filterStations();
      } catch (err) {
        document.getElementById('stationList').innerHTML = "Failed to load stations.";
      }
    }

    function closeFuelPopup() {
      document.getElementById('fuel-popup').style.display = 'none';
    }

    function filterStations() {
      const query = document.getElementById('fuel-search').value.toLowerCase();
      const fuelType = document.getElementById('fuel-type').value;

      const filtered = stations.filter(s => {
        const match = s.postcode?.toLowerCase().includes(query);
        const hasPrice = s[fuelType] != null;
        return match && hasPrice;
      });

      const list = document.getElementById('stationList');
      if (filtered.length === 0) {
        list.innerHTML = "<p>No stations found.</p>";
        return;
      }

      list.innerHTML = '';
      filtered.forEach(station => {
        const div = document.createElement('div');
        div.className = 'station-item';
        div.textContent = `${station.brand || 'Station'} - ${station.postcode} (${station[fuelType]}p)`;
        div.onclick = () => {
          document.getElementById(`${currentFuelField}-price`).value = station[fuelType];
          closeFuelPopup();
        };
        list.appendChild(div);
      });
    }

    function calculate() {
      const local = parseFloat(document.getElementById('local-price').value);
      const cheaper = parseFloat(document.getElementById('cheaper-price').value);
      const miles = parseFloat(document.getElementById('trip-distance').value);
      const mpg = parseFloat(document.getElementById('mpg').value);

      if (isNaN(local) || isNaN(cheaper) || isNaN(miles) || isNaN(mpg)) {
        document.getElementById('output').innerHTML = "<p>Please fill in all fields correctly.</p>";
        return;
      }

      const litresLocal = (10 / local) * 1000;
      const litresCheaper = (10 / cheaper) * 1000;
      const gallons = miles / mpg;
      const litresUsed = gallons * 4.54609;
      const costOfTrip = (litresUsed * local) / 100;
      const netSaving = ((local - cheaper) * 10 / 100) - costOfTrip;

      document.getElementById('output').innerHTML = `
        <p><strong>Local:</strong> ${litresLocal.toFixed(2)}L</p>
        <p><strong>Cheaper:</strong> ${litresCheaper.toFixed(2)}L</p>
        <p><strong>Cost of trip:</strong> Â£${costOfTrip.toFixed(2)}</p>
        <p><strong>Net savings:</strong> Â£${netSaving.toFixed(2)}</p>
        <h3>ðŸ¤” Is it worth it?</h3>
      `;
    }
  </script>
</body>
</html>

