<script>
const stationSelectType = { current: null };
const fuelTypeSelector = document.getElementById('fuel-type');
const localPriceInput = document.getElementById('local-price');
const cheaperPriceInput = document.getElementById('cheaper-price');
const findPriceButtons = document.querySelectorAll('.find-price-btn');

findPriceButtons.forEach(button => {
  button.addEventListener('click', async () => {
    const targetInput = button.previousElementSibling;
    stationSelectType.current = targetInput;
    document.getElementById('fuel-popup').style.display = 'flex';

    const popupContent = document.getElementById('fuel-popup-content');
    popupContent.innerHTML = '<p>Loading stations...</p>';

    try {
      const res = await fetch('/api/fuel');
      const data = await res.json();
      const fuelType = fuelTypeSelector.value;

      if (!data.stations || data.stations.length === 0) {
        popupContent.innerHTML = '<p>No stations found.</p>';
        return;
      }

      popupContent.innerHTML = data.stations.map(station => {
        const price = fuelType === 'diesel' ? station.diesel : station.unleaded;
        if (price === null) return '';
        return `<div class="station" data-price="${price}">
          <strong>${station.brand}</strong> - ${station.postcode}<br>
          Â£${price.toFixed(1)} / L
        </div>`;
      }).join('') || '<p>No prices available.</p>';

      document.querySelectorAll('.station').forEach(el => {
        el.addEventListener('click', () => {
          const price = el.getAttribute('data-price');
          stationSelectType.current.value = price;
          document.getElementById('fuel-popup').style.display = 'none';
        });
      });

    } catch (error) {
      popupContent.innerHTML = '<p>Failed to load station data.</p>';
    }
  });
});

document.getElementById('close-fuel-popup').addEventListener('click', () => {
  document.getElementById('fuel-popup').style.display = 'none';
});
</script>
